{# Find posts with shared tags, excluding current post #}
{% set relatedPosts = [] %}
{% if tags and tags.length > 0 %}
	{# Filter posts that share tags with current post #}
	{% for post in collections.posts %}
		{% if post.url != page.url and post.data.tags %}
			{% set hasSharedTag = false %}
			{% for tag in tags %}
				{% if tag in post.data.tags and tag != "featured" %}
					{% set hasSharedTag = true %}
				{% endif %}
			{% endfor %}
			{% if hasSharedTag %}
				{% set relatedPosts = (relatedPosts.push(post), relatedPosts) %}
			{% endif %}
		{% endif %}
	{% endfor %}
{% endif %}

{# If no related posts found, use recent posts (excluding current) #}
{% if relatedPosts.length == 0 %}
	{% for post in collections.posts %}
		{% if post.url != page.url %}
			{% set relatedPosts = (relatedPosts.push(post), relatedPosts) %}
		{% endif %}
	{% endfor %}
{% endif %}

{# Limit to 4 posts #}
{% set relatedPosts = relatedPosts | slice(0, 4) %}

{% if relatedPosts.length > 0 %}
{% if relatedPosts.length == 1 %}
	{% set sections_class = "global-sections-items-1" %}
{% elif relatedPosts.length == 2 %}
	{% set sections_class = "global-sections-items-2" %}
{% elif relatedPosts.length == 3 %}
	{% set sections_class = "global-sections-items-3" %}
{% else %}
	{% set sections_class = "global-sections-items-4" %}
{% endif %}
<div class="global-sections {{ sections_class }}">
	{% for post in relatedPosts %}
	{% if loop.first %}
	<h2 class="global-label global-zigzag">
		See more
		{% include "partials/icons/site/zigzag.njk" %}
	</h2>
	{% endif %}
	<article class="item-section {{ post.data.post_class or '' }}">
		<a href="{{ post.url }}" class="global-link" aria-label="{{ post.data.title }}"></a>
		{% if post.data.feature_image %}
		<div class="global-image">
			<img src="{{ post.data.feature_image }}" alt="{{ post.data.title }}">
		</div>
		{% endif %}
		<div class="global-sections-content">
			<h3><a href="{{ post.url }}">{{ post.data.title }}</a></h3>
			{% if settings.show_author and post.data.author %}
			<div class="global-sections-meta global-meta global-pointer">
				<a href="{{ site.author.url }}">{{ post.data.author.name }}</a>
			</div>
			{% endif %}
			{% if not post.data.feature_image %}
				{% if post.data.excerpt %}
				<p class="global-excerpt">
					{{ post.data.excerpt | truncate(72) }}...
				</p>
				{% endif %}
			{% endif %}
		</div>
	</article>
	{% endfor %}
</div>
{% endif %}